<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap PUBLIC
    "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
  <typeAlias alias="log" type="com.fost.prop.model.OperationLog" />

  <resultMap id="log" class="log">
    <result property="id" column="id" />
    <result property="operatorName" column="operator_name" />
    <result property="operatorId" column="operator_id" />
    <result property="event" column="event" />
    <result property="tableName" column="op_table" />
    <result property="createAt" column="created_at" />
    <result property="oldContent" column="old_content" />
    <result property="newContent" column="new_content" />
  </resultMap>

  <insert id="LogDao.insertLog" parameterClass="log">
    <selectKey resultClass="long" keyProperty="id">
       SELECT s_prop_log.nextval from dual
    </selectKey>
    insert into prop_log (id,
                          operator_name,
                          operator_id,
                          event,
                          op_table,
                          old_content,
                          new_content,
                          created_at)
                  values (#id#,
                          #operatorName#,
                          #operatorId#,
                          #event#,
                          #tableName#,
                          #oldContent#,
                          #newContent#,
                          sysdate)
  </insert>

  <sql id="LogDao.findLog">
    <![CDATA[
      select * from prop_log pg
      where pg.created_at between to_date(#beginTime#,'yyyy-mm-dd hh24:mi:ss') and to_date(#endTime#,'yyyy-mm-dd hh24:mi:ss')+1
    ]]>
    <dynamic>
        <isNotEmpty prepend="AND" property="operatorName">
           pg.operator_name = #operatorName#
        </isNotEmpty>
        <isGreaterThan prepend="and" property="operatorId" compareValue="0">
           pg.operator_id = #operatorId#
        </isGreaterThan>
        <isNotEmpty prepend="AND" property="event">
           pg.event = #event#
        </isNotEmpty>
    </dynamic>
     order by pg.id desc
  </sql>

  <select id="LogDao.findLogWithPage" parameterClass="java.util.HashMap" resultMap="log">
     <include refid="ORACLE.paginationStart"/>
     <include refid="LogDao.findLog"/>
     <include refid="ORACLE.paginationEnd"/>
  </select>

  <select id="LogDao.findLogSum" parameterClass="java.util.HashMap" resultClass="Integer">
     <include refid="recordSUM.start"/>
     <include refid="LogDao.findLog"/>
     <include refid="recordSUM.end"/>
  </select>
</sqlMap>
